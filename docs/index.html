 <!DOCTYPE html>
<html>
<title>40k Dice Roll Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<body>

<div class="w3-container">

<h1>Inputs</h1>

<label for="models">Models:</label>
<input type="number" id="models" name="models" min="1" value="5" style="width: 4em">
<br>
<label for="attacks">Attacks:</label>
<input type="number" id="attacks" name="attacks" min="0" value="2" style="width: 4em">
<label for="dice_attacks">+</label>
  <select name="dice_attacks" id="dice_attacks">
    <option value="None" selected="selected"></option>
    <option value="D6">D6</option>
    <option value="2D6">2D6</option>
    <option value="D3">D3</option>
	<option value="2D3">2D3</option>
</select>
<br> <br>

<label for="hit_on">Hit on:</label>
  <select name="hit_on" id="hit_on">
    <option value="2">2+</option>
    <option value="3">3+</option>
    <option value="4" selected="selected">4+</option>
    <option value="5">5+</option>
	<option value="6">6+</option>
	<option value="-1">Always</option>
  </select>
<label for="sustained_x">Sustained</label>
  <select name="sustained_x" id="sustained_x">
    <option value="0" selected="selected">0</option>
    <option value="1">1</option>
	<option value="2">2</option>
	<option value="3">3</option>
  </select>
<label for="sustained_on">on</label>
  <select name="sustained_on" id="sustained_on">
    <option value="7" selected="selected">Never</option>
    <option value="6">6+</option>
    <option value="5">5+</option>
    <option value="4">4+</option>
	<option value="3">3+</option>
	<option value="2">2+</option>
  </select>
<label for="lethal_on">lethal on</label>
  <select name="lethal_on" id="lethal_on">
    <option value="7" selected="selected">Never</option>
    <option value="6">6+</option>
    <option value="5">5+</option>
    <option value="4">4+</option>
	<option value="3">3+</option>
	<option value="2">2+</option>
  </select>
<label for="reroll_hit">reroll</label>
  <select name="reroll_hit" id="reroll_hit">
    <option value="0" selected="selected">Never</option>
    <option value="1">Roll of 1</option>
    <option value="7">All</option>
    <option value="once">Once</option>
  </select>
<br>



<label for="wound_on">Wound on:</label>
  <select name="wound_on" id="wound_on">
    <option value="2">2+</option>
    <option value="3">3+</option>
    <option value="4" selected="selected">4+</option>
    <option value="5">5+</option>
	<option value="6">6+</option>
  </select>
<label for="devastating_on">devastating on</label>
  <select name="devastating_on" id="devastating_on">
    <option value="7" selected="selected">Never</option>
    <option value="6">6+</option>
    <option value="5">5+</option>
    <option value="4">4+</option>
	<option value="3">3+</option>
	<option value="2">2+</option>
  </select>
<label for="reroll_wound">reroll</label>
  <select name="reroll_wound" id="reroll_wound">
    <option value="0" selected="selected">Never</option>
    <option value="1">Roll of 1</option>
    <option value="7">All</option>
    <option value="once">Once</option>
  </select>
  
  
<br>
<label for="save_on">Save on:</label>
  <select name="save_on" id="save_on">
    <option value="2">2+</option>
    <option value="3">3+</option>
    <option value="4" selected="selected">4+</option>
    <option value="5">5+</option>
	<option value="6">6+</option>
	<option value="7">Never</option>
  </select>
<br>

<label for="damage">Damage:</label>
<input type="number" id="damage" name="damage" min="0" value="1"  style="width: 4em">
<label for="dmg_rand">+</label>
  <select name="dmg_rand" id="dmg_rand">
    <option value="None" selected="selected"></option>
    <option value="D6">D6</option>
    <option value="2D6">2D6</option>
    <option value="D3">D3</option>
	<option value="2D3">2D3</option>
</select>
<label for="reroll_dmg_below">reroll a roll of</label>
  <select name="reroll_dmg_below" id="reroll_dmg_below">
    <option value="1" selected="selected">1</option>
    <option value="2"><=2</option>
    <option value="3"><=3</option>
	<option value="4"><=4</option>
	<option value="5"><=5</option>
	<option value="6"><=6</option>
  </select>
<label for="reroll_dmg_when"></label>
  <select name="reroll_dmg_when" id="reroll_dmg_when">
    <option value="Never" selected="selected">Never</option>
    <option value="Always">Always</option>
    <option value="Once">Once</option>
  </select>

<br>
<label for="wounds">Wounds:</label>
<input type="number" id="wounds" name="wounds" min="1" value="1"  style="width: 4em">
<label for="fnp">FNP</label>
<select name="fnp" id="fnp">
    <option value="7" selected="selected">None</option>
	<option value="6">6+</option>
	<option value="5">5+</option>
	<option value="4">4+</option>
</select>
<br>

  
<button type="button"
onclick="run_sim()">
Calculate</button>
</div>

<br>

<div class="w3-container">
<button type="button"
onclick="reset_rerolls()">
Reset re-rolls</button>
<button type="button"
onclick="reset_buffs()">
Reset buffs</button>
<button type="button"
onclick="reset_dice()">
Reset dice</button>
</div>


<div class="w3-container>
<h1>Results</h1>
<p id="target"></p>
<div class="w3-responsive">
<table class="w3-table w3-striped" id="results_table">
</table>
</div>
</div>

<br>

<div class="w3-container">
<div id="attacks_plot" style="width:100%;max-width:700px"></div>
<div id="wounds_plot" style="width:100%;max-width:700px"></div>
<div id="killed_plot" style="width:100%;max-width:700px"></div>
</div>

<br>
<div class="w3-container">
<h1>FAQ</h1>
<ul>
  <li>Regular textbook Monte-Carlo analysis is used</li>
  <li>Three sets of figures-of-merit are shown:</li>
  <ul>
	<li>Successful attacks: A successful attack consists of a successful hit (regular or from sustained), successful wound (lethal hit or regular), and a failed save.</li>
	<li>Raw damage inflicted. A sum of the damage inflicted by each successful attack, minus FNP effects if any.</li>
	<li>Number of models killed. Extra damage lost here.</li>
  </ul>
  <li>For each figure of merit, three alternative representations are shown (using inflicted damage as an example):</li>
    <ul>
	<li>Histogram: Probability of the &lt;inflicted damage&gt; being exactly this.</li>
	<li>Cumulative density: Probability of the &lt;inflicted damage&gt; being at most this.</li>
	<li>Survivorship: Probability of the &lt;inflicted damage&gt; being at least this.</li>
  </ul>
  <li>Four reroll options are available for most throws: No rerolls, reroll all failed, reroll each roll of 1, and one re-roll per model and throw type. Ironstorm-type one-re-roll-per-model scheme
  is not supported.</li>
  <li>For damage re-rolls, the user can also specify the reroll strategy, i.e. the dice threshold below which the roll should be rerolled.
</ul> 
</div>

<br>

<div>
<h2>Changelog</h2>
* Added wounds and kill counts
<br>
* Damage rerolls now implemented
<br>
* Plots, variable number of attacks
<br>
* Responsive layout
<br>
* FEEL! NO! PAIN!
<br>
* Style. Reset puttons.
</div>

<script>

const NROWS = 21;

//initializations
//let tbody = init_table();
let tbody = init_table_w3();

function reset_rerolls(){
document.getElementById('reroll_hit').value = 0;
document.getElementById('reroll_wound').value = 0;
document.getElementById('reroll_dmg_below').value = 1;
document.getElementById('reroll_dmg_when').value = "Never";
}

function reset_buffs(){
document.getElementById('sustained_x').value = 0;
document.getElementById('sustained_on').value = 7;
document.getElementById('lethal_on').value = 7;
document.getElementById('devastating_on').value = 7;
document.getElementById('fnp').value = 7;
}

function reset_dice(){
document.getElementById('dmg_rand').value = "None";
document.getElementById('dice_attacks').value = "None";
}



function run_sim(){

let data = parse_inputs();
console.log(data);

let sim_data = simulate(data);

//hits data
let hist_passes = compute_hist(sim_data.passes);
set_hit_hist(hist_passes, 1);

let passes_lt = compute_less_cum(hist_passes);
set_hit_hist(passes_lt, 2);

let passes_gt = compute_larger_cum(hist_passes);
set_hit_hist(passes_gt, 3);

//wounds data
let hist_dmg = compute_hist(sim_data.damages);
set_hit_hist(hist_dmg, 4);

let dmg_lt = compute_less_cum(hist_dmg);
set_hit_hist(dmg_lt, 5);

dmg_gt = compute_larger_cum(hist_dmg);
set_hit_hist(dmg_gt, 6);

//killed data
let hist_killed = compute_hist(sim_data.killed);
killed_lt = compute_less_cum(hist_killed);
set_hit_hist(killed_lt, 7);
killed_gt = compute_larger_cum(hist_killed);
set_hit_hist(killed_gt, 8);


// plotting
const count_range = [];
for (let x = 0; x <Nrows ; x++) {
  count_range.push(x);
}

const config = {responsive: true}

// passed attacks
let plot_data = [];
plot_data.push({x:count_range, y:hist_passes, mode:"lines", name:"Histogram"});
plot_data.push({x:count_range, y:passes_lt, mode:"lines", name:"At most"});
plot_data.push({x:count_range, y:passes_gt, mode:"lines", name:"At least"});
let layout = {title: "Successful attacks"};
Plotly.newPlot("attacks_plot", plot_data, layout, config);

//wounds
plot_data = [];
plot_data.push({x:count_range, y:hist_dmg, mode:"lines", name:"Histogram"});
plot_data.push({x:count_range, y:dmg_lt, mode:"lines", name:"At most"});
plot_data.push({x:count_range, y:dmg_gt, mode:"lines", name:"At least"});
layout = {title: "Inflicted damage (raw)"};
Plotly.newPlot("wounds_plot", plot_data, layout, config);

//killed
plot_data = [];
plot_data.push({x:count_range, y:hist_killed, mode:"lines", name:"Histogram"});
plot_data.push({x:count_range, y:killed_lt, mode:"lines", name:"At most"});
plot_data.push({x:count_range, y:killed_gt, mode:"lines", name:"At least"});
layout = {title: "Models destroyed"};
Plotly.newPlot("killed_plot", plot_data, layout, config);


}


function set_hit_hist(hist, kcol){

for (let krow=0; krow<NROWS;krow++){
	tbody.rows[krow+1].cells[kcol].innerHTML = Number(hist[krow]).toFixed(1);
}

}

function compute_hist(samples){
let per_bin = new Array(NROWS).fill(0);
for (let k = 0; k<samples.length; k++){
	let ind = samples[k];
	if (ind >= NROWS){
		ind = NROWS-1;
	}
	per_bin[ ind ] += 1.0 / samples.length*100.0;
}
return per_bin
}

function compute_less_cum(hist){
let cum = new Array(NROWS).fill(0);
let prev = 0;
for (let k = 0; k<NROWS; k++){
	cum[k] = hist[k] + prev;
	prev += hist[k]
}
return cum
}

function compute_larger_cum(hist){
let cum = new Array(NROWS).fill(0);
let prev = 0;
for (let k = Nrows-1; k>=0; k--){
	cum[k] = hist[k] + prev;
	prev += hist[k]
}
return cum
}

function simulate(data){

let Nsamples = 10000;
//Nsamples = 1;

let passed_per_sim = new Array(Nsamples).fill(0);
let damage_per_sim = new Array(Nsamples).fill(0);
let killed_per_sim = new Array(Nsamples).fill(0);
for (let ksample = 0; ksample < Nsamples; ksample++){
	// going through attack seq
	let number_of_attacks = 0;
	var passed_per_sample = 0;
	var dmg = 0;
	var killed = 0;
	var wounds_accumulated = 0;
	for (let kmodel = 1; kmodel<=data.models; kmodel++){
		var nhits = 0;
		var nwounds = 0;
		var npassed = 0;
		
		
		// hit roll for model
		number_of_attacks = data.A + multiD(data.dice_attacks);
		let n_rerolls = 0;
		let kattack = 0;
		while ( kattack<number_of_attacks){
			kattack++;
			hit = D6();
			if (hit >= data.hitroll.hit_on){
				nhits += 1;
			} else if (hit <= data.hitroll.reroll_below){
				n_rerolls += 1;
			}
			if (hit >= data.hitroll.lethal_on){
				nwounds += 1;
			}
			if (hit >= data.hitroll.sustained_on){
				nhits += data.hitroll.sustained_x;
			}
		}
		// hit rerolls
		n_rerolls = Math.min(data.hitroll.number_of_rerolls, n_rerolls);
		kattack = 0;
		while (kattack<n_rerolls){
			kattack++;
			hit = D6();
			if (hit >= data.hitroll.hit_on){
				nhits += 1;
			}
			if (hit >= data.hitroll.lethal_on){
				nwounds += 1;
			}
			if (hit >= data.hitroll.sustained_on){
				nhits += data.hitroll.sustained_x;
			}
		}
		
		// wound roll for model
		n_rerolls = 0;
		let kwound = 0;
		while ( kwound < nhits){
			kwound++;
			d6 = D6();
			if (d6 >= data.woundroll.wound_on){
			nwounds += 1;
			} else if (hit <= data.woundroll.reroll_below){
				n_rerolls += 1;
			}
			if (d6 >= data.woundroll.devastating_on){
				npassed += 1;
			}
		}
		// wound rerolls
		n_rerolls = Math.min(data.woundroll.number_of_rerolls, n_rerolls);
		kwound = 0;
		while (kwound < n_rerolls){
			kwound++;
			d6 = D6();
			if (d6 >= data.woundroll.wound_on){
			nwounds += 1;
			}
			if (d6 >= data.woundroll.devastating_on){
				npassed += 1;
			}
		}
		
		// save roll
		let ksave = 0;
		while (ksave < nwounds){
			ksave++;
			d6 = D6();
			if (d6 < data.saveroll.save_on){
				npassed += 1;
			}
		}
		passed_per_sample += npassed;
		
		// damage
		let dmg_per_attack = 0.0;
		let dice_dmg = 0.0;
		let number_rerolled = 0;
		for (let kdam=0; kdam<npassed;kdam++){
			dmg_per_attack = data.damage_roll.dmg;
			
			//dice 
			dice_dmg = multiD(data.damage_roll.dice_dmg);
			
			//reroll dice dmg?
			if (dice_dmg <= data.damage_roll.reroll_below && number_rerolled < damage_roll.number_of_rerolls) {
				number_rerolled += 1;
				dice_dmg = multiD(data.damage_roll.dice_dmg);
			}
			//add variable damage to attack damage
			dmg_per_attack += dice_dmg;
			
			//considering FNP
			let dam_orig = dmg_per_attack;
			for (let kfnp=0; kfnp<dam_orig; kfnp++){
				if (D6() >= data.fnp) {
					dmg_per_attack -= 1;
				}
			}
			
			// adding to cumulative damage
			dmg += dmg_per_attack;
			
			//check if model dies
			wounds_accumulated += dmg_per_attack;
			if (wounds_accumulated >= data.wounds){
				wounds_accumulated = 0;
				killed += 1;
			}
			
		}
	}
	passed_per_sim[ksample] = passed_per_sample;
	damage_per_sim[ksample] = dmg;
	killed_per_sim[ksample] = killed;
}
let sim_data = {};
sim_data.passes = passed_per_sim;
sim_data.damages = damage_per_sim;
sim_data.killed = killed_per_sim;

return sim_data;
}

function multiD(arg){
if (arg == "D6"){
	dice_dmg = D6();
} else if (arg == "2D6"){
	dice_dmg = D6() + D6();
} else if (arg == "D3"){
	dice_dmg = D3();
} else if (arg == "2D3"){
	dice_dmg = D3() + D3();
} else {
	dice_dmg = 0;
}
return dice_dmg;
}

function D6() {
  return Math.floor(Math.random() * 6) + 1;
}

function D3() {
  return Math.floor(Math.random() * 3) + 1;
}


function parse_inputs(){
let data = {};

data.A = Number(document.getElementById("attacks").value);
data.dice_attacks = document.getElementById("dice_attacks").value;

data.models = Number(document.getElementById("models").value);

hitroll = {};
hitroll.hit_on = Number(document.getElementById("hit_on").value);
hitroll.lethal_on = Number(document.getElementById("lethal_on").value);
hitroll.sustained_on = Number(document.getElementById("sustained_on").value);
hitroll.sustained_x = Number(document.getElementById("sustained_x").value);

reroll_input = document.getElementById("reroll_hit").value;
if (reroll_input == "once"){
	hitroll.reroll_below = 7;
	hitroll.number_of_rerolls = 1;
} else {
	hitroll.reroll_below = Number(reroll_input);
	hitroll.number_of_rerolls = data.A;
}


woundroll = {};
woundroll.wound_on = Number(document.getElementById("wound_on").value);
woundroll.devastating_on = Number(document.getElementById("devastating_on").value);

reroll_input = document.getElementById("reroll_wound").value;
if (reroll_input == "once"){
	woundroll.reroll_below = 7;
	woundroll.number_of_rerolls = 1;
} else {
	woundroll.reroll_below = Number(reroll_input);
	woundroll.number_of_rerolls = data.A;
}


saveroll = {};
saveroll.save_on = Number(document.getElementById("save_on").value);

damage_roll = {};
damage_roll.dmg = Number(document.getElementById("damage").value);
damage_roll.dice_dmg = document.getElementById("dmg_rand").value;

damage_roll.reroll_below = Number(document.getElementById("reroll_dmg_below").value);
reroll_input_when = document.getElementById("reroll_dmg_when").value;
if (reroll_input_when === "Once"){
	damage_roll.number_of_rerolls = 1;
} else if (reroll_input_when === "Never") {
	damage_roll.number_of_rerolls = 0;
} else {
	damage_roll.number_of_rerolls = data.A;
}

data.hitroll = hitroll;
data.woundroll = woundroll;
data.saveroll = saveroll;
data.damage_roll = damage_roll;
data.wounds = Number(document.getElementById("wounds").value);
data.fnp = Number(document.getElementById("fnp").value);


return data;
}


function init_table_w3(){
	var table = document.getElementById('results_table');
	//var header = document.createElement('thead');
	//header.innerHTML = "<tr><td></td></tr>";
	var body = document.createElement('tbody');

	Nrows = 21;
	Ncols = 9;
	
	//headers
	let titles = ["No.", "Successful attacks (hist, %)", "Successful attacks leq", "Successful attacks geq", "Dmg, hist", "Dmg leq", "Dmg geq", "Killed leq", "Killed geq"];
	var row = document.createElement('tr');
	for (let kcol=0; kcol<Ncols; kcol++){
			var cell = document.createElement('th');
			cell.innerHTML = titles[kcol];
			row.appendChild(cell);
	}
	body.appendChild(row);

	for (let krow=0; krow<Nrows;krow++){
		var row = document.createElement('tr');
		for (let kcol=0; kcol<Ncols; kcol++){
			var cell = document.createElement('td');
			cell.innerHTML = krow;
			row.appendChild(cell);
		}
		body.appendChild(row);
	}
	//table.appendChild(header);
	table.appendChild(body);

	//document.getElementById('target').appendChild(table);

	for (let krow=10000; krow<Nrows;krow++){
		for (let kcol=1; kcol<Ncols; kcol++){
			body.rows[krow].cells[kcol].innerHTML = 0.0 + "%"; 
		}
	}
	
	return body;
}

function init_table(){
	var table = document.createElement('table');
	var header = document.createElement('thead');
	header.innerHTML = "<tr><td></td></tr>";
	var body = document.createElement('tbody');

	Nrows = 21;
	Ncols = 9;
	
	//headers
	let titles = ["No.", "Successful attacks (hist, %)", "Successful attacks leq", "Successful attacks geq", "Dmg, hist", "Dmg leq", "Dmg geq", "Killed leq", "Killed geq"];
	var row = document.createElement('tr');
	for (let kcol=0; kcol<Ncols; kcol++){
			var cell = document.createElement('th');
			cell.innerHTML = titles[kcol];
			row.appendChild(cell);
	}
	body.appendChild(row);

	for (let krow=0; krow<Nrows;krow++){
		var row = document.createElement('tr');
		for (let kcol=0; kcol<Ncols; kcol++){
			var cell = document.createElement('td');
			cell.innerHTML = krow;
			row.appendChild(cell);
		}
		body.appendChild(row);
	}
	table.appendChild(header);
	table.appendChild(body);

	document.getElementById('target').appendChild(table);

	for (let krow=10000; krow<Nrows;krow++){
		for (let kcol=1; kcol<Ncols; kcol++){
			body.rows[krow].cells[kcol].innerHTML = 0.0 + "%"; 
		}
	}
	
	return body;
}


</script>

</body>
</html> 